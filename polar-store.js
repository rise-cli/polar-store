var Y=Object.defineProperty,Z=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var E=(e,t,n)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,o=(e,t)=>{for(var n in t||(t={}))V.call(t,n)&&E(e,n,t[n]);if(w)for(var n of w(t))F.call(t,n)&&E(e,n,t[n]);return e},C=(e,t)=>Z(e,Q(t));var r=(e,t,n)=>(E(e,typeof t!="symbol"?t+"":t,n),n),z=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)};var L=(e,t,n)=>(z(e,t,"read from private field"),n?n.call(e):t.get(e)),M=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)};var P=class{constructor(){r(this,"taskCount",0);r(this,"initialize",()=>{this.taskCount=0});r(this,"add",()=>{this.taskCount=this.taskCount+1});r(this,"isZero",()=>this.taskCount<1);r(this,"subtract",()=>this.taskCount<=1?(this.taskCount=0,{isZero:!0}):(this.taskCount=this.taskCount-1,{isZero:!1}))}},U=class{constructor(){r(this,"resolvers",[]);r(this,"makePausedPromise",()=>new Promise(t=>{this.resolvers.push(t)}));r(this,"makeCompletedPromise",()=>Promise.resolve());r(this,"resolveAllPausedPromises",()=>{let t=this.resolvers;this.resolvers=[],t.forEach(n=>n())})}},d=new P,k=new U;function p(){return d.add(),()=>{d.subtract().isZero&&k.resolveAllPausedPromises()}}function B(e){let t=p();return e().finally(t)}function X(){return d.isZero()?k.makeCompletedPromise():k.makePausedPromise()}function G(){d.initialize()}var m=Symbol(),c=Symbol(),H=0,J=(e,t,n,i)=>{let s=++H,l=o({},e);l.set=(...f)=>{e[m]=t,e[c]=s,e.set(...f),delete e[m],delete e[c]},e.setKey&&(l.setKey=(...f)=>{e[m]=t,e[c]=s,e.setKey(...f),delete e[m],delete e[c]});let u,a;if(e.action){let f=e.action(s,t,i);u=f[0],a=f[1]}let y=n(l,...i);if(y instanceof Promise){let f=p();return y.catch(I=>{throw u&&u(I),I}).finally(()=>{f(),a&&a()})}return a&&a(),y},W=(e,t,n)=>(...i)=>J(e,t,n,i);var v=class{constructor(){r(this,"queue",[]);r(this,"isEmpty",()=>this.queue.length===0);r(this,"empty",()=>{this.queue.length=0});r(this,"add",t=>{if(typeof t.listener!="function")throw new Error("object must have a listener function");if(typeof t.level!="number")throw new Error("object must have a level number");this.queue.push(t)});r(this,"emit",()=>{for(let t=0;t<this.queue.length;t+=1){let n=this.queue[t];this.isListenerTheLowestInTheRestOfTheQueue(t,n)?n.listener(n.value,n.changedKey):this.queue.push(n)}});r(this,"isListenerTheLowestInTheRestOfTheQueue",(t,n)=>{let i=!0;for(let s=t;s<this.queue.length&&i;s+=1)n.level>this.queue[s].level&&(i=!1);return i})}};var T=new v,x,O,R=class{constructor(t,n){r(this,"listeners",[]);r(this,"level",0);r(this,"numberOfListeners",0);r(this,"value",null);r(this,"get",()=>(this.numberOfListeners||this.listen(()=>{})(),this.value));r(this,"set",t=>{this.value!==t&&(this.value=t,this.notify())});M(this,x,(t,n)=>{let i={listener:t,level:n||this.level,id:Symbol()};return this.numberOfListeners=this.listeners.push(i),i.id});M(this,O,t=>()=>{let n=this.listeners.findIndex(i=>i.id===t);~n&&(this.listeners.splice(n,1),!--this.numberOfListeners&&this.off&&this.off())});r(this,"listen",(t,n)=>{let i=L(this,x).call(this,t,n);return L(this,O).call(this,i)});r(this,"subscribe",(t,n)=>{let i=this.listen(t,n);return t(this.value),i});r(this,"notify",t=>{let n=T.isEmpty();for(let i=0;i<this.listeners.length;i+=1)T.add({listener:this.listeners[i].listener,level:this.listeners[i].level,value:this.value,changedKey:t});n&&(T.emit(),T.empty())});r(this,"off",()=>{});this.level=n||0,this.value=t}};x=new WeakMap,O=new WeakMap;var h=(e,t)=>new R(e,t);var S=1e3,_=(e,t,n,i)=>(e.events=e.events||{},e.events[n+10]||(e.events[n+10]=i(s=>{e.events[n].reduceRight((l,u)=>(u(l),l),o({shared:{}},s))})),e.events[n]=e.events[n]||[],e.events[n].push(t),()=>{let s=e.events[n],l=s.indexOf(t);s.splice(l,1),s.length||(delete e.events[n],e.events[n+10](),delete e.events[n+10])}),g=(e,t)=>_(e,i=>{let s=t(i);s&&e.events[6].push(s)},5,i=>{let s=e.listen;e.listen=(...u)=>(!e.numberOfListeners&&!e.active&&(e.active=!0,i()),s(...u));let l=e.off;return e.events[6]=[],e.off=()=>{l(),setTimeout(()=>{if(e.active&&!e.numberOfListeners){e.active=!1;for(let u of e.events[6])u();e.events[6]=[]}},S)},()=>{e.listen=s,e.off=l}}),K=(e,t)=>_(e,t,3,n=>{let i=e.notify;return e.notify=s=>{let l;if(n({abort:()=>{l=!0},changed:s}),!l)return i(s)},()=>{e.notify=i}});var $=(e,t)=>{Array.isArray(e)||(e=[e]);let n,i=()=>{let l=e.map(u=>u.get());(n===void 0||l.some((u,a)=>u!==n[a]))&&(n=l,s.set(t(...l)))},s=h(void 0,Math.max(...e.map(l=>l.level))+1);return g(s,()=>{let l=e.map(u=>u.listen(i,s.level));return i(),()=>{for(let u of l)u()}}),s};function N(e,t){let n=D(t),i=e;for(let s of n){if(i===void 0)break;i=i[s]}return i}function A(e,t,n){return b(e!=null?e:{},D(t),n)}function b(e,t,n){let i=t[0];j(e,i,t[1]);let s=Array.isArray(e)?[...e]:o({},e);if(t.length===1)return n===void 0?Array.isArray(e)?s.splice(i,1):delete s[i]:s[i]=n,s;let l=b(e[i],t.slice(1),n);return e[i]=l,e}var q=/(.*)\[(\d+)\]/;function D(e){return e.split(".").flatMap(t=>q.test(t)?t.match(q).slice(1):[t])}function j(e,t,n){if(t in e)return;let i=parseInt(n!=null?n:"");Number.isNaN(i)?e[t]={}:e[t]=Array(i+1).fill(void 0)}function ee(e={}){let t=h(e);return t.setKey=(n,i)=>{N(t.value,n)!==i&&(t.value=A(t.value,n,i),t.notify(n))},t}function te(e,t,n){let i=new Set([...t,void 0]);return e.listen((s,l)=>{i.has(l)&&n(s,l)})}var ne=(e={})=>{let t=h(e);return t.setKey=function(n,i){typeof i>"u"?n in t.value&&(t.value=o({},t.value),delete t.value[n],t.notify(n)):t.value[n]!==i&&(t.value=C(o({},t.value),{[n]:i}),t.notify(n))},t};export{S as STORE_UNMOUNT_DELAY,W as action,c as actionId,X as allTasks,h as atom,ee as atomDeep,ne as atomMap,G as cleanTasks,$ as computed,N as getPath,m as lastAction,te as listenKeys,g as onMount,K as onNotify,A as setPath,p as startTask,B as task};
